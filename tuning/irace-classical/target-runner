#!/bin/bash
set -euo pipefail

error() {
  echo "$(TZ=UTC date): $0: error: $*" >&2
  exit 1
}

CONFIG_ID=$1
INSTANCE_ID=$2
SEED=$3
INSTANCE=$4
shift 4 || error "Not enough parameters"
CONFIG_PARAMS="$*"

EXE="julia"
command -v "$EXE" >/dev/null 2>&1 || error "$EXE not found"

EXE_PARAMS=(main.jl "$INSTANCE" "$SEED")
# Append irace-generated parameters (they include switches like --aco_alpha ...)
# shellcheck disable=SC2206
EXE_PARAMS+=( $CONFIG_PARAMS )

STDOUT="c${CONFIG_ID}-${INSTANCE_ID}-${SEED}.stdout"
STDERR="c${CONFIG_ID}-${INSTANCE_ID}-${SEED}.stderr"

"$EXE" "${EXE_PARAMS[@]}" >"$STDOUT" 2>"$STDERR" || {
  echo "Julia failed. Last stderr:" >&2
  tail -n 50 "$STDERR" >&2
  exit 1
}

LASTLINE="$(tail -n 1 "$STDOUT" || true)"
COST="$(printf '%s\n' "$LASTLINE" | grep -Eo '[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?' | head -n 1 || true)"

if [[ -z "${COST:-}" ]]; then
  echo "Could not parse cost." >&2
  echo "Last line was: $LASTLINE" >&2
  echo "Last stdout:" >&2
  tail -n 50 "$STDOUT" >&2
  echo "Last stderr:" >&2
  tail -n 50 "$STDERR" >&2
  exit 1
fi

printf '%s\n' "$COST"

rm -f "$STDOUT" "$STDERR"
exit 0
